name: Build Projects

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch: # 允许手动触发

jobs:
  build-admin-server-go:
    name: Build Admin Server (Go)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build Admin Server
        working-directory: admin-server/server
        run: |
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o ../../build/admin-server main.go

      - name: Upload Admin Server artifact
        uses: actions/upload-artifact@v4
        with:
          name: admin-server-binary
          path: build/admin-server
          retention-days: 7

  build-admin-server-web:
    name: Build Admin Server Web (Vue)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: admin-server/web/package-lock.json

      - name: Install dependencies
        working-directory: admin-server/web
        run: npm ci

      - name: Build Vue project
        working-directory: admin-server/web
        run: npm run build

      - name: Upload Admin Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: admin-server-web
          path: admin-server/web/dist
          retention-days: 7

  build-goapi:
    name: Build GoAPI (Go)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build GoAPI
        working-directory: goapi
        run: |
          mkdir -p build
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o build/goapi ./cmd/server

      - name: Upload GoAPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: goapi-binary
          path: goapi/build/goapi
          retention-days: 7

  build-sms-client:
    name: Build SMS Client (Flutter)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get Flutter dependencies
        working-directory: sms-client
        run: flutter pub get

      - name: Build Flutter Web
        working-directory: sms-client
        run: flutter build web --release

      - name: Upload SMS Client artifact
        uses: actions/upload-artifact@v4
        with:
          name: sms-client-web
          path: sms-client/build/web
          retention-days: 7

  # 可选：将所有构建产物打包在一起
  package-all:
    name: Package All Builds
    runs-on: ubuntu-latest
    needs: [build-admin-server-go, build-admin-server-web, build-goapi, build-sms-client]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release package
        run: |
          mkdir -p release
          # 复制所有构建产物到 release 目录
          if [ -f admin-server-binary/admin-server ]; then
            mkdir -p release/admin-server
            cp admin-server-binary/admin-server release/admin-server/
          fi
          if [ -d admin-server-web ]; then
            cp -r admin-server-web release/admin-server-web
          fi
          if [ -f goapi-binary/goapi ]; then
            mkdir -p release/goapi
            cp goapi-binary/goapi release/goapi/
          fi
          if [ -d sms-client-web ]; then
            cp -r sms-client-web release/sms-client-web
          fi

      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: release
          retention-days: 30


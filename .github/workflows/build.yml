name: Build Projects

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch: # 允许手动触发
    inputs:
      build_admin_server_go:
        description: 'Build Admin Server (Go)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - true
          - false
      build_admin_server_web:
        description: 'Build Admin Server Web (Vue)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - true
          - false
      build_goapi:
        description: 'Build GoAPI (Go)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - true
          - false
      build_sms_client:
        description: 'Build SMS Client (Flutter)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - true
          - false

jobs:
  # 检测哪些目录有变更
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      admin-server-go: ${{ steps.filter.outputs.admin-server-go }}
      admin-server-web: ${{ steps.filter.outputs.admin-server-web }}
      goapi: ${{ steps.filter.outputs.goapi }}
      sms-client: ${{ steps.filter.outputs.sms-client }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: filter
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # 手动触发时，根据输入决定
            echo "admin-server-go=${{ github.event.inputs.build_admin_server_go }}" >> $GITHUB_OUTPUT
            echo "admin-server-web=${{ github.event.inputs.build_admin_server_web }}" >> $GITHUB_OUTPUT
            echo "goapi=${{ github.event.inputs.build_goapi }}" >> $GITHUB_OUTPUT
            echo "sms-client=${{ github.event.inputs.build_sms_client }}" >> $GITHUB_OUTPUT
          else
            # 自动检测变更
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
              HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            else
              BASE_SHA="${{ github.event.before }}"
              HEAD_SHA="${{ github.event.after }}"
            fi
            
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA || echo "")
            
            if echo "$CHANGED_FILES" | grep -q "^admin-server/server/"; then
              echo "admin-server-go=true" >> $GITHUB_OUTPUT
            else
              echo "admin-server-go=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$CHANGED_FILES" | grep -q "^admin-server/web/"; then
              echo "admin-server-web=true" >> $GITHUB_OUTPUT
            else
              echo "admin-server-web=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$CHANGED_FILES" | grep -q "^goapi/"; then
              echo "goapi=true" >> $GITHUB_OUTPUT
            else
              echo "goapi=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$CHANGED_FILES" | grep -q "^sms-client/"; then
              echo "sms-client=true" >> $GITHUB_OUTPUT
            else
              echo "sms-client=false" >> $GITHUB_OUTPUT
            fi
          fi

  build-admin-server-go:
    name: Build Admin Server (Go)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.admin-server-go == 'true' || (needs.detect-changes.outputs.admin-server-go == 'auto' && github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build Admin Server
        working-directory: admin-server/server
        run: |
          mkdir -p ../../build
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o ../../build/admin-server main.go

      - name: Upload Admin Server artifact
        uses: actions/upload-artifact@v4
        with:
          name: admin-server-binary
          path: build/admin-server
          retention-days: 7

  build-admin-server-web:
    name: Build Admin Server Web (Vue)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.admin-server-web == 'true' || (needs.detect-changes.outputs.admin-server-web == 'auto' && github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: admin-server/web/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('admin-server/web/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
        continue-on-error: true

      - name: Install dependencies
        working-directory: admin-server/web
        run: npm ci

      - name: Build Vue project
        working-directory: admin-server/web
        run: npm run build

      - name: Upload Admin Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: admin-server-web
          path: admin-server/web/dist
          retention-days: 7

  build-goapi:
    name: Build GoAPI (Go)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.goapi == 'true' || (needs.detect-changes.outputs.goapi == 'auto' && github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build GoAPI
        working-directory: goapi
        run: |
          mkdir -p build
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o build/goapi ./cmd/server

      - name: Upload GoAPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: goapi-binary
          path: goapi/build/goapi
          retention-days: 7

  build-sms-client:
    name: Build SMS Client (Flutter)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.sms-client == 'true' || (needs.detect-changes.outputs.sms-client == 'auto' && github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get Flutter dependencies
        working-directory: sms-client
        run: flutter pub get

      - name: Build Flutter Web
        working-directory: sms-client
        run: flutter build web --release

      - name: Upload SMS Client artifact
        uses: actions/upload-artifact@v4
        with:
          name: sms-client-web
          path: sms-client/build/web
          retention-days: 7

  # 可选：将所有构建产物打包在一起
  package-all:
    name: Package All Builds
    runs-on: ubuntu-latest
    needs: [build-admin-server-go, build-admin-server-web, build-goapi, build-sms-client]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release package
        run: |
          mkdir -p release
          # 复制所有构建产物到 release 目录
          if [ -f admin-server-binary/admin-server ]; then
            mkdir -p release/admin-server
            cp admin-server-binary/admin-server release/admin-server/
          fi
          if [ -d admin-server-web ]; then
            cp -r admin-server-web release/admin-server-web
          fi
          if [ -f goapi-binary/goapi ]; then
            mkdir -p release/goapi
            cp goapi-binary/goapi release/goapi/
          fi
          if [ -d sms-client-web ]; then
            cp -r sms-client-web release/sms-client-web
          fi

      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: release
          retention-days: 30
